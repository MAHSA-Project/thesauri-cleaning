# Thesauri Update Scripts 

This repository contains a set of Python scripts to manage, compare, and update thesauri data between Arches output, BI sheets, the CDB PostgreSQL database, and ODK forms. The scripts are designed to be run in a specific order to ensure data consistency and integrity.

## Workflow Overview

flowchart TD

A\[Script 1: Compare list names\] --> B\[Script 2: Compare concepts\]

B --> C\[Script 3: Create new BI sheet\]

C --> D\[Script 4: Check CDB connection\]

D --> E\[Script 5: Update CDB concepts\]

E --> F\[Script 6: Create ODK sheet\]

The wrapper script thesauri_update_run_all_scripts.py automates the sequential execution of these scripts, pausing between scripts to show progress and ask for user confirmation.

##Scripts Overview

###1\. 1_listname_lesh_arch_comparison.py

- Compares list names from thesauri and Arches output.
- Produces a spreadsheet showing matches and mismatches.
- **Action:** Fix any mismatched list names before proceeding.

###2\. 2_concept_thes_arch_comparison.py

- Compares concepts in matching list names.
- Produces a spreadsheet showing matching and non-matching concepts.
- Saves a **complete concepts Excel sheet**.
- **Action:**
  - You can continue with only matching concepts, or
  - Fix mismatches and rerun from **Script 1**.

###3\. 3_bi_spreadsheet_concept_update.py

- Creates a new BI sheet with all matching concepts from the complete concepts sheet.
- **Action:** Manually move the new BI sheet to the correct folder after verification.

###4\. 4_list_concepts_in_CDB.py

- Checks that a connection to the **PostgreSQL CDB database** can be established.
- **Note:** Database connection information is stored in a .env file.
- No changes are made to the database; this is a validation step.

###5\. 5_replace_CDB_concepts_with_arch_thesauri.py

- Connects to the CDB database.
- Moves all concepts from mahsa_thesauri to mahsa_thesauri_backup.
- Deletes all concepts from mahsa_thesauri and inputs new concepts from the complete concepts spreadsheet (from Script 2).

###6\. 6_ODK_sheet_creator.py

- Creates a new ODK spreadsheet using:
  - Concepts from the complete concepts spreadsheet
  - Users and institutions from the common_bulk_import spreadsheet
  - ODK-specific terms from the thesauri spreadsheet
- **Action:** Manually move the saved spreadsheet to the main ODK folder.

##Wrapper Script

###thesauri_update_run_all_scripts.py

- Runs all six scripts sequentially.
- Pauses between scripts to show progress.
- Prompts the user to continue or abort after each script (except the last).
- Stops immediately if any script fails, showing which script failed.
- Only prints "All scripts completed successfully" if every script ran without errors.

##Requirements

The scripts require the following Python packages:

- pandas
- numpy
- openpyxl
- xlwings
- csv
- os
- sys
- subprocess
- re
- shutil
- datetime
- difflib
- dotenv
- psycopg2

##Notes & Tips

- Ensure all scripts are in the same folder before running the wrapper.
- Verify spreadsheets generated by Scripts 1-3 before proceeding.
- Keep your .env file secure, as it contains database connection credentials.
- Always back up existing CDB data before running Script 5.